{% extends 'base.html' %}
{% load static %}


{% block cabecera %}

<!-- Select2 -->
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}" />
<link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}" />

<!-- Font Awesome -->
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
  integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
<!-- Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"
  integrity="sha256-VBLiveTKyUZMEzJd6z2mhfxIqz3ZATCuVMawPZGzIfA=" crossorigin="anonymous"></script>
<!-- Spanish setting local Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/es.js"></script>
<!-- Tempus Dominus Bootstrap 4 -->

<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />

{% endblock cabecera %}


{% block contenido %}

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <!-- Default box -->
        <div class="card col-lg-8">
          <div class="card-header ">
            <h4 class="card-title col-6">
              <strong>VENTAS | Empresa Isla de Canrash S.R.L.</strong>
            </h4>
            <div class="card-tools">
              <button type="button" class="btn btn-tool dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-file-excel  fa-2x"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-right" role="menu">
                <a href="#" class="dropdown-item">
                  <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-success">
                    Importar datos de Excel
                  </button>
                </a>
                <a class="dropdown-divider">
                </a>
              </div>

              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
              </button>

            </div>
          </div>


          <div class="card-body">
            <!-- form start -->

            <form id="myForm" action="#" method="POST">
              <!-- Grupo 1 formulario -->
              <div class="invoice p-3 mb-3">
                <!-- title row -->
                <div class="row">
                  <div class="col-12">
                    <h5>
                      <i class="fas fa-shopping-cart"></i> Boleta nueva N°
                      {{ boletaVentaRestaurante.last.id |add:"1"  }}
                      <small class="float-right">
                        <div class="form-group">
                          <div class="input-group date" id="datetimepicker4" data-target-input="nearest">
                            <input type="text" class="form-control datetimepicker-input" data-target="#datetimepicker4"
                              name="fecha_venta" />
                            <div class="input-group-append" data-target="#datetimepicker4" data-toggle="datetimepicker">
                              <div class="input-group-text">
                                <i class="fa fa-calendar"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                      </small>
                    </h5>
                  </div>
                  <!-- /.col -->
                </div>
                <!-- info row -->
                <div class="row invoice-info">
                  <div class="col invoice-col">
                    <address>
                      <!-- Cliente -->
                      <div class="form-group row">
                        <label for="inputCliente" class="col-3 col-sm-2 col-form-label">
                          <strong>Cliente:</strong>
                        </label>
                        <div class="col-7 col-sm-9">
                          <select class="form-control select2bs4" style="width: 100%;"
                            onchange="cargar_cliente(this.value)">
                            {% comment %}
                            {% for proveedor in proveedores %}
                            <option>{{proveedor.nombre}}</option>
                            {% endfor %}
                            {% endcomment %}
                          </select>
                        </div>
                        <div class="col-2 col-sm-1" style="text-align: center">
                          <i id="simbolo_agregar" class="fas fa-plus-circle fa-2x" style="color: #007bff;"></i>
                        </div>
                      </div>


                      <!-- Tipo de cliente -->
                      <div class="form-group row">
                        <label for="inputTipo" class="col-3 col-sm-2 col-form-label">
                          <strong>Tipo:</strong>
                        </label>
                        <div class="col-9 col-sm-10">
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="far fa-building"></i>
                              </span>
                            </div>
                            <input id="tipoCliente" readonly="readonly" type="text" class="form-control"
                              data-inputmask='"mask":"9 9999 9999 9"' data-mask />
                          </div>
                        </div>
                      </div>

                      <!-- DNI -->
                      <div class="form-group row">
                        <label for="inputDNI" class="col-3 col-sm-2 col-form-label">
                          <strong>DNI:</strong>
                        </label>
                        <div class="col-9 col-sm-10">
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="far fa-building"></i>
                              </span>
                            </div>
                            <input id="dni" readonly="readonly" type="text" class="form-control"
                              data-inputmask='"mask":"9 9999 9999 9"' data-mask />
                          </div>
                        </div>
                      </div>

                      <!-- Correo -->
                      <div class="form-group row">
                        <label for="inputProveedor" class="col-3 col-sm-2 col-form-label">
                          <strong>Celular:</strong>
                        </label>
                        <div class="col-9 col-sm-10">
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="fas fa-phone"></i>
                              </span>
                            </div>
                            <input id="celular" readonly="readonly" type="text" class="form-control"
                              data-inputmask='"mask":"999-999-999"' data-mask />
                          </div>
                        </div>
                      </div>

                      <!-- Celular -->
                      <div class="form-group row">
                        <label for="inputProveedor" class="col-3 col-sm-2 col-form-label">
                          <strong>Correo:</strong>
                        </label>
                        <div class="col-9 col-sm-10">
                          <div class="input-group">
                            <div class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="fas fa-envelope"></i>
                              </span>
                            </div>
                            <input id="correo" readonly="readonly" type="text" class="form-control" />
                          </div>
                        </div>
                      </div>

                      <!-- Comentarios -->
                      <div class="form-group row">
                        <label for="inputComentarios" class="col-3 col-sm-2 col-form-label">
                          <strong>Comentarios:</strong>
                        </label>
                        <div class="col-9 col-sm-10">
                          <textarea class="form-control" rows="3"
                            placeholder="Es opcional dejar un comentario ..."></textarea>
                        </div>
                      </div>

                    </address>
                  </div>
                  <!-- /.col -->
                </div>
                <!-- /.row -->

                <!-- Table row -->
                <div class="row">
                  <div class="col-12 table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Plato</th>
                          <th>Cantidad</th>
                          <th>Precio unitario (S/.)</th>
                          <th>Importe (S/.)</th>
                          <th>Acción</th>
                        </tr>
                      </thead>
                      <tbody id="tabla_compras">
                        <tr id="fila_1">
                          <td>
                            <select class="form-control select2bs4" style="width: 100%;"
                              onchange="cargar_plato(this.value)">
                              {% for plato in platoPadre %}
                              <option>{{plato.nombre}}</option>
                              {% endfor %}
                          </td>
                          <td>
                            <input type="number" step="1" placeholder='0' value='0' min="0"
                              onclick="obtener_importe(this.value)" class="form-control">
                          </td>
                          <td>
                            <input id="precio_unitario" readonly="readonly" type="text" class="form-control"
                              placeholder="0">
                          </td>
                          <td>
                            <input id="importe" type="number" readonly="readonly" class="form-control importe_parcial"
                              value="0" placeholder="0">
                          </td>
                          <td>
                            <a class="btn btn-danger btn-sm" href="#" onclick="deleteRow(this)">
                              <i class="fas fa-trash"> </i>
                              Borrar
                            </a>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="text-center"><a id="agregar_fila" href="javascript:void(0);">
                        Agregar fila
                        <i class="fas fa-plus-circle fa-lg"></i> </a> </div>
                  </div>

                  <!-- /.col -->
                </div>
                <!-- /.row -->
                <hr
                  style="width: 100%; color: rgb(233, 230, 230); height: 1px; background-color:rgb(233, 230, 230); " />
                <div class="row">
                  <!-- accepted payments column -->
                  <div class="col-6"> <br> </div>
                  <!--    <div class="col-6">
                                      <p class="lead">Escanea el código QR:</p>

                                      <img src="https://tctechcrunch2011.files.wordpress.com/2012/08/qr-code.png"
                                          alt="qr code" width="100" height="100" />
                                      <p class="text-muted well well-sm shadow-none" style="margin-top: 10px;">
                                          * Recuerda verificar la veracidad de la boleta con el
                                          código qr
                                      </p>
                                  </div> -->

                  <!-- /.col -->
                  <div class="col-6">
                    <p class="lead">Resumen</p>

                    <div class="table-responsive">
                      <table class="table">
                        <!-- <tr>
                        <th>Shipping:</th>
                        <td>$5.80</td>
                        </tr> -->
                        <tr>
                        <tr>
                          <th style="width:50%">Total:</th>
                          <td class="total_importe">0</td>
                        </tr>
                        </tr>
                      </table>
                    </div>
                  </div>
                  <!-- /.col -->
                </div>
                <!-- /.row -->
                <!-- this row will not appear when printing -->
                <div class="row no-print">
                  <div class="col-12">
                    <!--   <a href="#" target="_blank" class="btn btn-default"><i
                                              class="fas fa-print"></i> Imprimir ahora</a> -->
                    <button id="btnGuardar" type="button" class="btn btn-success float-right">
                      <i class="far fa-credit-card"></i> Guardar <strong>venta</strong>
                    </button>
                    <!--       <button type="button" class="btn btn-primary float-right"
                                          style="margin-right: 5px;">
                                          <i class="fas fa-download"></i> Generar <strong>PDF</strong>
                                      </button> -->
                  </div>
                </div>
              </div>
              <!-- /.invoice -->
              <!--    <button type="submit" class="btn btn-outline-success">
                              Agregar <strong>compras</strong> al sistema
                          </button> -->
            </form>
          </div>
          <!-- /.card-body -->
          <!-- <div class="card-footer">
                      Empresa EICA
                  </div> -->
          <!-- /.card-footer-->
        </div>
        <!-- /.card -->
        <hr style="width: 100%; color: red; height: 1px; background-color:red;" />

        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <strong>VENTAS</strong> | Se muestran últimas 10
                </h3>

                <div class="card-tools">
                  <div class="input-group input-group-sm" style="width: 150px;">
                    <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar" />

                    <div class="input-group-append">
                      <button type="submit" class="btn btn-default">
                        <i class="fas fa-search"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /.card-header -->
              <div class="card-body table-responsive p-0">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Boleta</th>
                      <th>Comentarios</th>
                      <th>Fecha venta</th>
                      <th>Cliente</th>
                      <th>Nro platos</th>
                      <th>Total (S/.)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for boleta in tablaBoletasVenta %}
                    {% if  forloop.counter <= 10 %}
                    <tr>
                      <td>
                        <a href="#">N° {{boleta.id_boleta_venta_restaurante}}</a>
                      </td>
                      <td>
                        {{boleta.id_boleta_venta_restaurante.comentario}}
                      </td>
                      <td>
                        {{boleta.id_boleta_venta_restaurante.fecha_venta}}
                      </td>
                      <td>
                        Falta setear cliente
                      </td>
                      <td>
                        {{boleta.nro_productos}}
                      </td>
                      <td>
                        S/. {{boleta.precio_total}}
                      </td>
                      {% comment %} <td class="project-actions text-right">
                        <a class="btn btn-primary btn-sm" href="#">
                          <i class="fas fa-folder"> </i>
                          View
                        </a>
                        <a class="btn btn-info btn-sm" href="#">
                          <i class="fas fa-pencil-alt"> </i>
                          Edit
                        </a>
                        <a class="btn btn-danger btn-sm" href="#">
                          <i class="fas fa-trash"> </i>
                          Delete
                        </a>
                      </td> {% endcomment %}

                    </tr>
                    {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ADD MODALS HERE-->

<div class="modal fade" id="modal-success">
  <div class="modal-dialog">
    <div class="modal-content bg-success">
      <div class="modal-header">
        <h4 class="modal-title">
          <i class="fas fa-file-excel "></i>
          Importar desde excel
        </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;
          </span>
        </button>
      </div>
      <div class="modal-body">
        <p>Para poder importar correctamente se tiene que ingresar documentos con formatos predefinidos para que estos
          puedan ser leídos por el sistema.
        </p>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-light" data-dismiss="modal"
          onclick="location.href = 'https://docs.google.com/spreadsheets/d/1AH2juP4xG_x9cB2wel7BDoOhlHr-Ul2uALlui8NbJX4/edit?usp=sharing'">
          Descargar
          plantilla
        </button>
        <button type="button" class="btn btn-outline-light">
          Subir archivo
        </button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>


<!-- /.MODALS-->

{% endblock contenido %}

{% block pie %}

<!-- Select2 -->
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<!-- date-range-picker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/datepicker/0.6.5/datepicker.min.js"
  integrity="sha256-/7FLTdzP6CfC1VBAj/rsp3Rinuuu9leMRGd354hvk0k=" crossorigin="anonymous"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js">
</script>
<!-- InputMask -->
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- serializeToJSON -->
<script src="{% static 'plugins/formtojson/src/jquery.serializeToJSON.js' %}"></script>


<!-- Add here more js -->

<!-- Page script -->
<script type="text/javascript">
  $(function () {
    //Initialize Select2 Elements
    $(".select2").select2({});

    //Initialize Select2 Elements
    $(".select2bs4").select2({
      theme: "bootstrap4"
    });
    //Date picker
    $("#datetimepicker4").datetimepicker({
      locale: "es",
      format: "L",
      date: moment(), // Fecha de hoy predifinida
      format: "DD/MM/YYYY"
    });
    //Date mask
    $("[data-mask]").inputmask();

    //Add here more functions


  });
</script>

<!-- Script to add new row  and delete-->
<script type="text/javascript">
  /* ADD ROW*/
  var cantidad_rows = 1;
  $('#agregar_fila').click(function () {

    /* Se clona y añade*/
    var tablita = $('#tabla_compras')[0];
    var rowCount = tablita.rows.length;
    objeto_primera_fila = $('#fila_1')
    primera_fila = objeto_primera_fila[0];

    objeto_primera_fila.children(":first").children("select").select2("destroy");

    copia_primera_fila = primera_fila.cloneNode(true);

    objeto_primera_fila.children(":first").children("select").select2({
      theme: "bootstrap4"
    });

    copia_primera_fila.id = "fila_" + (cantidad_rows + 1);
    cantidad_rows++;
    tablita.append(copia_primera_fila);

    $('#fila_' + cantidad_rows).children(":first").children("select").select2({
      theme: "bootstrap4"
    });

  });
  /* DELETE ROW*/
  function deleteRow(currentRow) {
    try {
      var tablita = $('#tabla_compras')[0];
      var rowCount = tablita.rows.length;
      for (var i = 0; i < rowCount; i++) {
        var row = tablita.rows[i];
        /*var chkbox = row.cells[0].childNodes[0];*/
        /*if (null != chkbox && true == chkbox.checked)*/

        if (row == currentRow.parentNode.parentNode) {
          if (rowCount <= 1) {
            alert("No se pueden borrar todas las filas!");
            break;
          }
          if (i == 0) {
            alert("No se puede borrar la primera fila!");
            break;
          }
          tablita.deleteRow(i);
          rowCount--;
          i--;
        }
      }
    } catch (e) {
      alert(e);
    }
    //getValues();
  }

  /*Hallar el monto total de la boleta*/
  $('.importe_parcial').on('click', function () {
    console.log('Se ha cambiado el importe_parcial');
    var total = 0.0;
    $('.importe_parcial').each(function () {
      var $this = $(this);
      var price = parseFloat($this.val());
      total += price;

    })
    total = total.toFixed(2);
    $('.total_importe').text(total);

  });
  $('.importe_parcial').trigger('change');
</script>
<!-- Script to load data when proveedor is selected  -->
<script type="text/javascript">
  $(document).ready(function () {
    //var json_proveedores = JSON.parse('{{ json_proveedores | safe}}');
    //var data_filter = json_proveedores.filter(element => element.pk == 1);
    //$('#ruc')[0].value = data_filter[0].fields.ruc;
    //$('#celular')[0].value = data_filter[0].fields.celular;
    //$('#correo')[0].value = data_filter[0].fields.correo;
  });

  function cargar_cliente(selectedValue) {

    //var json_proveedores = JSON.parse('{{ json_proveedores | safe}}');
    //var data_filter = json_proveedores.filter(element => element.fields.nombre == selectedValue);
    //$('#ruc')[0].value = data_filter[0].fields.ruc;
    //$('#celular')[0].value = data_filter[0].fields.celular;
    //$('#correo')[0].value = data_filter[0].fields.correo;
  };

  function cargar_plato(selectedValue) {

    var json_platoVenta = JSON.parse('{{  json_platoVenta | safe }}');
    var json_platoPadre = JSON.parse('{{  json_platoPadre | safe }}');

    var plato_seleccionado = json_platoPadre.filter(element => element.fields.nombre == selectedValue);
    var plato_venta_seleccionado = json_platoVenta.filter(element => element.fields.id_plato_padre ==
      plato_seleccionado[0].pk);
    var precio_unitario = plato_venta_seleccionado[0].fields.precio_venta

    $('#precio_unitario')[0].value = precio_unitario;

  };

  function obtener_importe(selectedValue) {

    precio_unitario = $('#precio_unitario')[0].value;

    $('#importe')[0].value = precio_unitario * selectedValue;

  };


  $(function () {
    $("#btnGuardar").on("click", function () {

      //var i = 0;
      //var columnas = 4;
      //var num_fila = 0;
      //$('.form-control').each(function () {
      //  if (i == 0) {
      //    // nothing
      //  } else if (i == 1) {
      //    $(this).attr('name', "fecha");
      //  } else if (i == 2) {
      //    $(this).attr('name', "cliente");
      //  } else if (i == 3) {
      //    $(this).attr('name', "dni");
      //  } else if (i == 4) {
      //    $(this).attr('name', "celular");
      //  } else if (i == 5) {
      //    $(this).attr('name', "correo");
      //  } else {
      //    if (i % columnas == 2) {
      //      $(this).attr('name', "productos[" + num_fila + "].producto");
      //    }
      //    if (i % columnas == 3) {
      //      $(this).attr('name', "productos[" + num_fila + "].cantidad");
      //    }
      //    if (i % columnas == 0) {
      //      $(this).attr('name', "productos[" + num_fila + "].precio_unitario");
      //    }
      //    if (i % columnas == 1) {
      //      $(this).attr('name', "productos[" + num_fila + "].importe");
      //      num_fila++;
      //    }
      //  }
      //  i++;
      //});
      //console.log($("#myForm").serializeToJSON());
    })
  });
</script>

{% endblock pie %}