{% extends 'base.html' %}
{% load static %}

{% block cabecera %}
<!--Para mostrar la moneda S/.-->
<style>
    .input-icon {
        position: relative;
    }

    .input-icon>i {
        position: absolute;
        display: block;
        transform: translate(0, -50%);
        top: 50%;
        pointer-events: none;
        width: 25px;
        text-align: center;
        font-style: normal;
    }

    .input-icon>input {
        padding-left: 25px;
        padding-right: 0;
    }

    .input-icon-right>i {
        right: 0;
    }

    .input-icon-right>input {
        padding-left: 0;
        padding-right: 25px;
        text-align: right;
    }
</style>


<!-- Select2 -->
<link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}" />
<link rel="stylesheet" href="{% static 'plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css' %}" />

<!-- Font Awesome -->
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
<!-- Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"
    integrity="sha256-VBLiveTKyUZMEzJd6z2mhfxIqz3ZATCuVMawPZGzIfA=" crossorigin="anonymous"></script>
<!-- Spanish setting local Moment.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/es.js"></script>
<!-- Tempus Dominus Bootstrap 4 -->
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />


{% endblock cabecera %}

{% block contenido %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 ">
                <!-- Default box -->
                <div class="card col-lg-8">
                    <div class="card-header ">
                        <h4 class="card-title">
                            <strong><strong>COMPRAS</strong> | Empresa Isla de
                                Canrash
                                S.R.L.</strong>
                        </h4>

                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" data-toggle="tooltip"
                                title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                            <!-- <button type="button" class="btn btn-tool" data-card-widget="remove" data-toggle="tooltip" title="Remove">
                            <i class="fas fa-times"></i></button> -->
                            <!-- Botones para cerrar ventana -->
                        </div>
                    </div>

                    <!-- Aviso  -->
                    <!-- <div class="ribbon-wrapper ribbon-xl">
                    <div class="ribbon bg-warning text-lg">
                        En construcción
                    </div>
                </div> -->

                    <div class="card-body">
                        <!-- form start -->

                        <form id="myForm" action="" method="POST">
                            <!-- csrf token -->
                            {% csrf_token %}
                            <input type="hidden" name="id_boleta_compra" value="{{boletasCompra.last.id |add:"1"}}">
                            <!-- Grupo 1 formulario -->
                            <div class="invoice p-3 mb-3">
                                <!-- title row -->
                                <div class="row">
                                    <div class="col-12">
                                        <h5>
                                            <i class="fas fa-shopping-cart"></i> Boleta nueva N°
                                            {{ boletasCompra.last.id |add:"1"  }}
                                            <small class="float-right">
                                                <div class="form-group">
                                                    <div class="input-group date" id="datetimepicker4"
                                                        data-target-input="nearest">
                                                        <input type="text" class="form-control datetimepicker-input"
                                                            data-target="#datetimepicker4" name="fecha_compra" />
                                                        <div class="input-group-append" data-target="#datetimepicker4"
                                                            data-toggle="datetimepicker">
                                                            <div class="input-group-text">
                                                                <i class="fa fa-calendar"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </small>
                                        </h5>
                                    </div>
                                    <!-- /.col -->
                                </div>
                                <!-- info row -->
                                <div class="row invoice-info">
                                    <div class="col invoice-col">
                                        <address>
                                            <!-- Proveedor -->
                                            <div class="form-group row">
                                                <label for="inputProveedor"
                                                    class="col-3 col-sm-2 col-form-label"><strong>Proveedor:</strong></label>
                                                <div class=" col-7 col-sm-9">
                                                    <select class="form-control select2bs4" style="width: 100%;"
                                                        onchange="cargar_proveedor(this.value)" name="id_proveedor">
                                                        <option value="0">----Agregar Nuevo----</option>
                                                        {% for proveedor in proveedores %}
                                                        {% if forloop.last %}
                                                        <option selected="selected" value="{{proveedor.pk}}">
                                                            {{proveedor.nombre}}</option>
                                                        {% else %}
                                                        <option value="{{proveedor.pk}}">{{proveedor.nombre}}</option>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-2 col-sm-1" style="text-align: center">

                                                        <i id="simbolo_agregar"  title="Agregar Nuevo Proveedor" onclick="agregar_nuevo_proveedor(this);return false;" class="fas fa-plus-circle fa-2x"  style="color: #007bff;"></i>
                                                        {% comment %}
                                                        <kbd> Agregar Nuevo</kbd>
                                                        {% endcomment %}
                                                    
                                                </div>
                                            </div>

                                            <!-- RUC -->
                                            <div class="form-group row">
                                                <label for="inputProveedor" class="col-3 col-sm-2 col-form-label">
                                                    <strong>RUC:</strong></label>
                                                <div class="col-9 col-sm-10">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="far fa-building"></i>
                                                            </span>
                                                        </div>
                                                        <input id="ruc" readonly type="text" class="form-control"
                                                            data-inputmask='"mask":"9 9999 9999 9"' data-mask />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Correo -->
                                            <div class="form-group row">
                                                <label for="inputProveedor" class="col-3 col-sm-2 col-form-label">
                                                    <strong>Celular:</strong>
                                                </label>
                                                <div class="col-9 col-sm-10">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="fas fa-phone"></i>
                                                            </span>
                                                        </div>
                                                        <input id="celular" readonly type="text" class="form-control"
                                                            data-inputmask='"mask":"999-999-999"' data-mask />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Correo -->
                                            <div class="form-group row">
                                                <label for="inputProveedor" class="col-3 col-sm-2 col-form-label">
                                                    <strong>Correo:</strong>
                                                </label>
                                                <div class="col-9 col-sm-10">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="fas fa-envelope"></i>
                                                            </span>
                                                        </div>
                                                        <input id="correo" readonly type="text" class="form-control" />
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Comentarios -->
                                            <div class="form-group row">
                                                <label for="inputComentarios" class="col-3 col-sm-2 col-form-label">
                                                    <strong>Comentarios:</strong>
                                                </label>
                                                <div class="col-9 col-sm-10">
                                                    <textarea class="form-control" rows="3"
                                                        placeholder="Es opcional dejar un comentario ..."></textarea>
                                                </div>
                                            </div>

                                            <!-- /. Rows-->
                                        </address>
                                    </div>
                                    <!-- /.col -->
                                </div>
                                <!-- /.row -->

                                <!-- Table row -->
                                <div class="row">
                                    <div class="col-12 table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Producto</th>
                                                    <th>Cantidad</th>
                                                    <th>Unidad</th>
                                                    <th>Precio (S/.)</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla_compras">
                                                <tr id="fila_1">
                                                    <td>
                                                        <select class="form-control select2bs4" style="width: 100%;"
                                                            onchange="cargar_producto(this.value,this.name)"
                                                            name="id_producto_padre_1">
                                                            {% for producto in productoPadre %}
                                                            {% if forloop.last %}
                                                            <option selected="selected" value="{{producto.pk}}">
                                                                {{producto.nombre}}</option>
                                                            {% else %}
                                                            <option value="{{producto.pk}}">{{producto.nombre}}</option>
                                                            {% endif %}
                                                            {% endfor %}

                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" step="00.01" placeholder='00.00'
                                                            value='00.00' min="0" class="form-control"
                                                            name="Cantidad_1">
                                                    </td>
                                                    <td>
                                                        <input readonly="readonly" type="text" class="form-control"
                                                            id="Unidad_1">
                                                    </td>
                                                    <td class="input-icon"> <i>S/.</i> <input type="number" step="00.01"
                                                            placeholder='00.00' value='00.0' min="0"
                                                            class="form-control precio" name="Precio_1">
                                                    </td>
                                                    <td>
                                                        <a class="btn btn-danger btn-sm" href=""
                                                            onclick="deleteRow(this);return false;">
                                                            <i class="fas fa-trash"> </i>
                                                            Borrar
                                                        </a>
                                                    </td>

                                                </tr>

                                            </tbody>
                                        </table>
                                        <div class="text-center">
                                            <a id="agregar_fila" href="javascript:void(0);">
                                                Agregar fila
                                                <i class="fas fa-plus-circle fa-lg"></i>
                                            </a>
                                        </div>
                                    </div>

                                    <!-- /.col -->
                                </div>
                                <!-- /.row -->
                                <hr
                                    style="width: 100%; color: rgb(233, 230, 230); height: 1px; background-color:rgb(233, 230, 230); " />
                                <div class="row">
                                    <!-- accepted payments column -->
                                    <div class="col-6"> <br> </div>
                                    <!--    <div class="col-6">
                                    <p class="lead">Escanea el código QR:</p>

                                    <img src="https://tctechcrunch2011.files.wordpress.com/2012/08/qr-code.png"
                                        alt="qr code" width="100" height="100" />
                                    <p class="text-muted well well-sm shadow-none" style="margin-top: 10px;">
                                        * Recuerda verificar la veracidad de la boleta con el
                                        código qr
                                    </p>
                                </div> -->

                                    <!-- /.col -->
                                    <div class="col-6">
                                        <p class="lead">Resumen</p>

                                        <div class="table-responsive">
                                            <table class="table">
                                                <!-- <tr>
                                                <th>Shipping:</th>
                                                <td>$5.80</td>
                                            </tr> -->
                                                <tr>
                                                    <th style="width:50%">Total:</th>
                                                    <td class="total">265.24</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- /.col -->
                                </div>
                                <!-- /.row -->
                                <!-- this row will not appear when printing -->
                                <div class="row no-print">
                                    <div class="col-12">
                                        <!--   <a href="" target="_blank" class="btn btn-default"><i
                                            class="fas fa-print"></i> Imprimir ahora</a> -->
                                        <button id="btnGuardar" class="btn btn-success float-right" type="submit"
                                            value="Guardar" name="_save">
                                            <i class="far fa-credit-card"></i> Guardar <strong>compra</strong>
                                        </button>
                                        <!--       <button type="button" class="btn btn-primary float-right"
                                        style="margin-right: 5px;">
                                        <i class="fas fa-download"></i> Generar <strong>PDF</strong>
                                    </button> -->
                                    </div>
                                </div>
                            </div>
                            <!-- /.invoice -->
                            <!--    <button type="submit" class="btn btn-outline-success">
                            Agregar <strong>compras</strong> al sistema
                        </button> -->
                        </form>
                    </div>
                    <!-- /.card-body -->
                    <!-- <div class="card-footer">
                    Empresa EICA
                </div> -->
                    <!-- /.card-footer-->
                </div>
                <!-- /.card -->
                <hr style="width: 100%; color: red; height: 1px; background-color:red;" />

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <strong>BOLETAS DE COMPRA</strong> | Se muestran las últimas 10
                                </h3>

                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <input type="text" name="table_search" class="form-control float-right"
                                            placeholder="Buscar" />

                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-default">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body table-responsive p-0">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Boleta</th>
                                            <th>Descripción</th>
                                            <th>Fecha</th>
                                            <th>Proveedor</th>
                                            <th>Nro. de productos</th>
                                            <th>Total (S/.)</th>
                                            {% comment %}
                                            <th>Fecha</th>
                                            {% endcomment %}
                                        </tr>
                                    </thead>
                                    <tbody>

                                        {% for boleta in tablaBoletas %}
                                        {% if  forloop.counter <= 10 %}
                                        <tr>
                                            <td>
                                                <a href="#">N° {{boleta.id_boleta_compra}}</a>
                                            </td>
                                            <td>
                                                {{boleta.id_boleta_compra.comentario}}
                                            </td>
                                            <td>
                                                {{boleta.id_boleta_compra.fecha_compra}}
                                            </td>
                                            <td>
                                                {{boleta.id_proveedor.nombre}}
                                            </td>
                                            <td>
                                                {{boleta.nro_productos}}
                                            </td>
                                            <td>
                                                {{boleta.precio_total}}
                                            </td>
                                            {% comment %}
                                            <td>{{producto.id_boleta_compra.fecha_compra}}</td>
                                            {% endcomment %}
                                            {% comment %}
                                            <td class="project-actions text-right">
                                                <a class="btn btn-primary btn-sm" href="">
                                                    <i class="fas fa-folder"> </i>
                                                    View
                                                </a>
                                                <a class="btn btn-info btn-sm" href="">
                                                    <i class="fas fa-pencil-alt"> </i>
                                                    Edit
                                                </a>
                                                <a class="btn btn-danger btn-sm" href="">
                                                    <i class="fas fa-trash"> </i>
                                                    Delete
                                                </a>
                                            </td>
                                            {% endcomment %}

                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock contenido %}

{% block pie %}

<!-- Select2 -->
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<!-- date-range-picker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/datepicker/0.6.5/datepicker.min.js"
    integrity="sha256-/7FLTdzP6CfC1VBAj/rsp3Rinuuu9leMRGd354hvk0k=" crossorigin="anonymous"></script>
<script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js">
</script>
<!-- InputMask -->
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/inputmask/min/jquery.inputmask.bundle.min.js' %}"></script>
<!-- serializeToJSON -->
<script src="{% static 'plugins/formtojson/src/jquery.serializeToJSON.js' %}"></script>


<!-- Add here more js -->

<!-- Page script -->
<script type="text/javascript">
    $(function () {
        //Initialize Select2 Elements
        $(".select2").select2({});

        //Initialize Select2 Elements
        $(".select2bs4").select2({
            theme: "bootstrap4"
        });
        //Date picker
        $("#datetimepicker4").datetimepicker({
            locale: "es",
            format: "L",
            date: moment(), // Fecha de hoy predifinida
            format: "DD/MM/YYYY"
        });
        //Date mask
        $("[data-mask]").inputmask();


        //Add here more functions


    });
</script>

<!-- Script to add new row and delete-->
<script type="text/javascript">
    /* ADD ROW*/
    var cantidad_rows = 1;
    $('#agregar_fila').click(function () {

        var tablita = $('#tabla_compras')[0];
        var rowCount = tablita.rows.length;
        objeto_primera_fila = $('#fila_1')
        primera_fila = objeto_primera_fila[0];

        objeto_primera_fila.children(":first").children("select").select2("destroy");

        copia_primera_fila = objeto_primera_fila.clone(true, true)[0];

        objeto_primera_fila.children(":first").children("select").select2({
            theme: "bootstrap4"
        });

        copia_primera_fila.id = "fila_" + (cantidad_rows + 1);
        copia_primera_fila.childNodes[1].childNodes[1].setAttribute("name", "id_producto_padre_" + (
            cantidad_rows + 1));
        copia_primera_fila.childNodes[3].childNodes[1].setAttribute("name", "Cantidad_" + (cantidad_rows + 1));
        copia_primera_fila.childNodes[5].childNodes[1].setAttribute("id", "Unidad_" + (cantidad_rows + 1));
        copia_primera_fila.childNodes[7].childNodes[3].setAttribute("name", "Precio_" + (cantidad_rows + 1));

        cantidad_rows++;

        tablita.append(copia_primera_fila);

        $('#fila_' + cantidad_rows).children(":first").children("select").select2({
            theme: "bootstrap4"
        });
        /*Actualizar Ids de las filas*/
        var tablita = $('#tabla_compras')[0];
        var rowCount = tablita.rows.length;
        for (var i = 0; i < rowCount; i++) {
            console.log(tablita.rows[i]);
            var row = tablita.rows[i];
            row.id = "fila_" + (i + 1);
            row.childNodes[1].childNodes[1].setAttribute("name", "id_producto_padre_" + (i + 1));
            row.childNodes[3].childNodes[1].setAttribute("name", "Cantidad_" + (i + 1));
            row.childNodes[5].childNodes[1].setAttribute("id", "Unidad_" + (i + 1));
            row.childNodes[7].childNodes[3].setAttribute("name", "Precio_" + (i + 1));

        };
    });

    /* DELETE ROW*/
    function deleteRow(currentRow) {
        try {
            var tablita = $('#tabla_compras')[0];
            var rowCount = tablita.rows.length;
            for (var i = 0; i < rowCount; i++) {
                var row = tablita.rows[i];
                /*var chkbox = row.cells[0].childNodes[0];*/
                /*if (null != chkbox && true == chkbox.checked)*/

                if (row == currentRow.parentNode.parentNode) {
                    if (rowCount <= 1) {
                        alert("No se pueden borrar todas las filas!");
                        break;
                    }
                    if (i == 0) {
                        alert("No se puede borrar la primera fila!");
                        break;
                    }
                    tablita.deleteRow(i);
                    rowCount--;
                    i--;

                }
            }
            /*Actualizar Ids de las filas*/
            for (var i = 0; i < rowCount; i++) {
                console.log(tablita.rows[i]);
                var row = tablita.rows[i];
                row.id = "fila_" + (i + 1);
                row.childNodes[1].childNodes[1].setAttribute("name", "id_producto_padre_" + (i + 1));
                row.childNodes[3].childNodes[1].setAttribute("name", "Cantidad_" + (i + 1));
                row.childNodes[5].childNodes[1].setAttribute("id", "Unidad_" + (i + 1));
                row.childNodes[7].childNodes[3].setAttribute("name", "Precio_" + (i + 1));

            };
        } catch (e) {
            alert(e);
        }

    };

    /*Hallar el monto total de la boleta*/
    $('.precio').on('change', function () {
        console.log('Se ha cambiado el precio');
        var total = 0.0;
        $('.precio').each(function () {
            var $this = $(this);
            var price = parseFloat($this.val());
            total += price;
        })
        total = total.toFixed(2);
        $('.total').text(total);

    });
    $('.precio').trigger('change');
</script>

<!-- Script to load data when proveedor is selected  -->
<script type="text/javascript">
    $(document).ready(function () {

        var json_proveedores = JSON.parse('{{ json_proveedores | safe}}');
        var data_filter = json_proveedores.filter(element => element.pk == 1);

        $('#ruc')[0].value = data_filter[0].fields.ruc;
        $('#celular')[0].value = data_filter[0].fields.celular;
        $('#correo')[0].value = data_filter[0].fields.correo;

    });

    function cargar_proveedor(selectedValue) {
        if (selectedValue != 0) { // selectedValue=0 es cuando se quiere agregar un nuevo proveedor
            var json_proveedores = JSON.parse('{{ json_proveedores | safe}}');
            var data_filter = json_proveedores.filter(element => element.pk == selectedValue);
            $('#ruc')[0].value = data_filter[0].fields.ruc;
            $('#celular')[0].value = data_filter[0].fields.celular;
            $('#correo')[0].value = data_filter[0].fields.correo;
            $('#ruc').attr("readonly", "readonly");
            $('#celular').attr("readonly", "readonly");
            $('#correo').attr("readonly", "readonly");
        } else {
            $('#ruc')[0].value = '';
            $('#celular')[0].value = '';
            $('#correo')[0].value = '';
            $('#ruc').removeAttr("readonly");
            $('#celular').removeAttr("readonly");
            $('#correo').removeAttr("readonly");

        };
    };

    function agregar_nuevo_proveedor(objeto){
        if($("#simbolo_agregar").attr("class") != "fas fa-search fa-2x"){
            $("#simbolo_agregar").attr("class","fas fa-search fa-2x");
            $("#simbolo_agregar").attr("title","Buscar Proveedores");
        }else{
            $("#simbolo_agregar").attr("class","fas fa-plus-circle fa-2x");
            $("#simbolo_agregar").attr("title","Agregar Nuevo Proveedor");
        
        }
    }

    function cargar_producto(selectedValue, name) {

        var json_producto_hijo = JSON.parse('{{  json_producto_hijo | safe }}');
        var json_producto_padre = JSON.parse('{{  json_producto_padre | safe }}');
        var json_producto_padre_filtrado = json_producto_padre.filter(p => p.pk == selectedValue);

        $('#Unidad_' + (name.slice(-1)))[0].value = json_producto_padre_filtrado[0].fields.unidad;


    };

</script>

<!-- Aqui van todas las inicializaciones-->
<script>
$(document).ready(function(){
   $("#simbolo_agregar").css({"cursor":"pointer"});
   
});


</script>
{% endblock pie %}